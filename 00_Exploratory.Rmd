---
title: "Exploratory Analysis"
author: "Brad Dixon <rd729c@att.com>"
date: "July 15, 2015"
output: 
  html_document: 
    keep_md: yes
---

```{r Initialization,include=FALSE}
library(ProjectTemplate)
load.project()
library(scales)
theme_set(theme_bw())
```

# Primary Training Data

```{r merge_test_and_train}
DATA = bind_rows(
  mutate(train.set, dataset = "TRAIN", id = NA),
  mutate(test.set,  dataset = "TEST")
) %>% 
  mutate_each( funs(factor), tube_assembly_id, supplier, dataset) %>% 
  mutate( quote_date = ymd(quote_date))

print(summary(DATA))
```

```{r pairs}
# DATA %>% 
#   filter(dataset == "TRAIN" ) %>% 
#   select( annual_usage, min_order_quantity, bracket_pricing, quantity, cost ) %>% 
#   mutate(
#     nzmoq = min_order_quantity > 0,
#     nzau = annual_usage > 0
#   ) %>% 
#   ggpairs(
#     lower=list(continuous="smooth", params=c(colour="blue") ),
#     diag=list(continuous="bar", params=c(colour="blue", fill="blue")),
#     upper=list(params=c(colour="blue", fill="blue"))
#   ) %>% 
#   print
```

## Quotes from Multiple Suppliers

```{r quotes_from_multiple_suppliers}
DATA %>% 
  filter(dataset=="TRAIN") %>% 
  group_by(tube_assembly_id) %>% 
  summarize(
    num_suppliers = length(unique(supplier))
  ) %>% 
  filter( num_suppliers > 1) %>% 
  arrange( desc(num_suppliers))
```

* Some tube assemblies have quotes from multiple suppliers.

```{r quotes_from_multiple_suppliers_and_date}
DATA %>% 
  filter(dataset=="TRAIN") %>% 
  group_by(tube_assembly_id, quote_date) %>% 
  summarize(
    num_suppliers = length(unique(supplier))
  ) %>% 
  filter( num_suppliers > 1) %>% 
  arrange( desc(num_suppliers))
```

* This seems due to shifting suppliers and not competitive bidding with one exception.

```{r TA-08627}
filter(DATA, tube_assembly_id=="TA-08627")
```

* Note the difference in `annual_usage`.

## Tubes Quoted by Supplier

```{r tubes_quoted_by_supplier}
DATA %>% 
  filter(dataset=="TRAIN") %>% 
  group_by( supplier ) %>% 
  summarize(
    num_tubes = length(unique(tube_assembly_id))
  ) %>% 
  filter( num_tubes > 1) %>% 
  arrange( desc(num_tubes ))
```

* Suppliers provide multiple types of tubes.

## Repeated Quotes over Time

```{r repeated_quotes_over_time}
DATA %>% 
  filter(dataset=="TRAIN") %>% 
  group_by( tube_assembly_id, supplier ) %>% 
  summarize(
    num_quote_dates = length(unique(quote_date))
  ) %>% 
  filter( num_quote_dates > 1 ) %>% 
  arrange( desc(num_quote_dates) )
```

* Occassional re-quotes on different dates by a supplier

## Supplier and Tube Overlap Between Train and Test

```{r tt_overlap}
DATA %>% 
  group_by( supplier, tube_assembly_id ) %>% 
  summarize(
    test = sum(which(dataset=="TEST")),
    train = sum(which(dataset=="TRAIN"))
  ) %>% 
  filter( test>0, train>0)
```

* No overlap between test and train on a supplier and tube basis. We must use the attributes of the tube to predict the cost.

```{r tt_overlap2}
DATA %>% 
  group_by( supplier ) %>% 
  summarize(
    test = length(which(dataset=="TEST")),
    train = length(which(dataset=="TRAIN"))
  ) %>% 
  filter( test>0, train>0 ) %>% 
  arrange(desc(train))
```

* Significant number of quotes from vendors present in both test and train.

```{r tt_overlap3}
DATA %>% 
  group_by( tube_assembly_id ) %>% 
  summarize(
    test = length(which(dataset=="TEST")),
    train = length(which(dataset=="TRAIN"))
  ) %>% 
  filter( test>0, train>0 ) %>% 
  arrange(desc(train))
```

* But tubes are not present in both test and train. Got to use the tube characteristics to make a prediction.

## Bracket Pricing Cost vs. Quantity

```{r bracket_cost_vs_quantity}
BRACKET_DISCOUNT = DATA %>% 
  filter(
    dataset=="TRAIN",
    bracket_pricing=="Yes"
  ) %>% 
  group_by( tube_assembly_id, supplier, quote_date ) %>% 
  mutate(
    cost_fraction = cost / max(cost)
  ) %>% 
  select( quantity, cost, cost_fraction) %>% 
  print

ggplot( BRACKET_DISCOUNT, aes( quantity, cost_fraction) ) +
  geom_point()
```

## Date

```{r date_year}
DATA %>% 
  group_by( year=year(quote_date), dataset ) %>% 
  summarize( num_quotes = n ()) %>% 
  ggplot(aes(year, num_quotes, color=dataset) ) +
    geom_line()
```

```{r date_quarter}
DATA %>% 
  group_by( quarter=factor(quarter(quote_date)), dataset ) %>% 
  summarize( num_quotes = n ()) %>% 
  ggplot(aes(quarter, num_quotes, fill=quarter) ) +
    geom_bar(stat="identity") +
    facet_grid( ~ dataset )
```

# Supplemental Data

## BOM

```{r BOM}
print(glimpse(BOM))

BOMSUMMARY = BOM %>% 
  group_by( tube_assembly_id ) %>% 
  summarize(
    num_components = n(),
    num_parts = sum(quantity)
  )
print(summary(BOM))

DATA %>% 
  filter( dataset=="TRAIN" ) %>% 
  select( tube_assembly_id, cost ) %>% 
  left_join( BOMSUMMARY ) %>% 
  ggplot( aes( num_parts, log(cost+1)) ) +
    geom_point( colour = "blue" ) +
    geom_smooth()
```

## TUBE

```{r tube}
print(glimpse(TUBE))
print(summary(TUBE))
table(TUBE$bend_radius>360)

TUBE %>%
  group_by(num_bends) %>% 
  summarise_each( funs(min, mean, max), bend_radius)

table(cut(TUBE$bend_radius, 10))
table(TUBE$num_bends)
table(TUBE$num_boss)
table(TUBE$num_bracket)
table(TUBE$other)
```

* `bend_radius`: There are some really bendy tubes! Looks like an alias to NA or an off scale value.
* `end_a` and `end_x`: `NONE` should be `NA`.
* `num_bends`, `num_boss`, `num_bracket`, `other` should be treated as categorical (factors).
* `length` has an outlier with a value 1333.

```{r tube_ggpairs}
DATA %>% 
  filter( dataset == "TRAIN", min_order_quantity==0 ) %>% 
  left_join(TUBE) %>% 
  select( diameter, wall, length, bend_radius, cost ) %>% 
  # Trim some outliers
  filter(
    bend_radius < 500,
    length < 1000
  ) %>% 
  # Lets be funky and multiply these physical measurements together
  mutate_each( funs(rescale(., c(1,2))), diameter, wall, length, bend_radius) %>% 
  mutate(
    dimmult = diameter * wall * length * bend_radius
  ) %>% 
  ggpairs
```

# Benchmark Comparison

## RF Benchmark

From the [0.2748 with RF and log transformation
](https://www.kaggle.com/ademyttenaere/caterpillar-tube-pricing/0-2748-with-rf-and-log-transformation/code) script.

```{r rf_benchmark}
COMP = rf.benchmark %>% 
  tbl_df %>% 
  rename(benchmark=cost) %>% 
  mutate(
    sub_rf_20150718_1 = read.csv("reports/submission_rf_20150718_RF-3-ge16d7f8-dirty.csv")[,2],
    sub_rf_20150718_2 = read.csv("reports/submission_rf_20150718_RF-8-g53a7563-dirty.csv")[,2]
  ) %>% 
  mutate_each( funs( log(.+1) - log(benchmark+1) ), starts_with("sub_")) %>% 
  gather( metric, value, -id, -benchmark )

COMP %>% 
  ggplot( aes( benchmark, value, color=metric )) +
    geom_point(size=1) +
    geom_smooth() +
    geom_hline(yintercept=0, color="black") +
    xlab("Cost estimated by benchmark") +
    ylab("Difference in log transformed price: predicted - benchmark") +
    ggtitle("Model vs. RF Benchmark from Forum")
```